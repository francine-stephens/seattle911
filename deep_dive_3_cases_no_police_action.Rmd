---
title: Seattle 911 Calls for Service - Deep Dive on Disturbance, Suspicious Person,
  and Trespass Cases and Cases resolved with No police action possible
author: "Francine Stephens"
date: "Last Updated: `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: united
    highlight: tango
---

```{r setup, include=F, warning=F, message=F}
knitr::opts_chunk$set(echo=F)

## Libraries
options(tidyverse.quiet = T)
packages <- c(
              "tidyverse",
              "scales",
              "naniar",
              "lubridate",
              "googleway",
              "sf",
              "sp",
              "ggplot2",
              "ggmap",
              "maptools",
              "raster",
              "spatstat",
              "plotly",
              "KernSmooth",
              "tigris",
              "leaflet",
              "RColorBrewer", 
              "censusapi", 
              "tidycensus", 
              "openxlsx"
              )
lapply(packages, library, character.only = T)
options(dplyr.summarise.inform = F)

## Local Paths 
setwd("~/Projects/seattle911")
wd <- getwd()
shp_path <- "/shp"
precs_path <- "/Spd_Precincts/"


## FUNCTIONS
ks <- function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }

```




The goal of this set of analyses is to take a deeper dive into the 2019 Seattle calls for service data. To follow up on the [preliminary exploratory analysis](https://francine-stephens.github.io/francinestephens.github.io/cad19_eda.html), we will focus on three types of cases - Disturbance, Suspicious person, and trespass - as well as one type of case resolution - No possible action possible. The questions we want to address here include the following?

1) Where did the three types of cases occur? 
2) How were these three types of cases resolved?
3) Does the type of resolution differ by location? 
4) What types of cases were cleared without police action? 
5) Where are the cases that were resolved without police action located?


## Focal Case Types


```{r data import, warning=F, message=F}
## IMPORT AND REDUCE TO FOCAL CASE TYPES
cad <- readRDS("cad_2019_data.rds")

cad <- cad %>%
  mutate(event_datetime = mdy_hm(Event_First_Dispatch_Time_ATTR),
         event_date = as.Date(event_datetime),
         event_month = month(event_datetime, label=T), 
         Call_Priority_Code = factor(Call_Priority_Code,
                                     levels = c("-1",
                                                "1",
                                                "2",
                                                "3",
                                                "4",
                                                "5",
                                                "6",
                                                "7",
                                                "8",
                                                "9")),
         case_type_final_desc_first = str_trim(str_extract(Case_Type_Final_Desc, "[^-]+"),
                                          side = c("both")), 
         case_type_final_desc_second = str_trim(str_extract(Case_Type_Final_Desc, "[^-]*$"),
                                           side = c("both")),
         response_time_parsed = seconds_to_period(CAD_Event_Response_Time_Seconds_SUM),
         total_service_time_parsed = seconds_to_period(Total_Service_Time_Seconds_SUM)
  )

focal_cases <- cad %>%
  filter(str_detect(case_type_final_desc_first, 'DIST') |
         case_type_final_desc_second == "SUSPICIOUS PERSON" |
         str_detect(Case_Type_Final_Desc, "TRESPASS")) %>%
    mutate(case_type = recode_factor(case_type_final_desc_first,
                                     "DIST" = "Disturbance",
                                     "DISTURBANCE, MISCELLANEOUS/OTHER" = "Disturbance",
                                     "DISTURBANCE" = "Disturbance",
                                     "SUSPICIOUS CIRCUM." = "Suspicious Person",
                                     "TRESPASS" = "Trespass",
                                     "PROWLER" = "Trespass")
           )


## SUBSET INTO DATAFRAMES OF INTEREST
disturbances_sf <- cad %>% 
  filter(str_detect(case_type_final_desc_first, 'DIST')) %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)

suspicious_person_sf <- cad %>%
  filter(case_type_final_desc_second == "SUSPICIOUS PERSON") %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)
  

trespass_sf <- cad %>%
  filter(str_detect(Case_Type_Final_Desc, "TRESPASS")) %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)


## CASE TYPES TABLE
knitr::kable(focal_cases %>% 
               count(case_type), 
             caption = "Table 1: Frequency of Focal Case Types",
  col.names = c("Case Type", "# of Calls"), 
  format.args = list(big.mark = ",")
)

```


```{r assign locations, include=F, warning=F, message=F}
#summary(focal_cases)
  # 47 cases don't have a precinct/sector
          # focal_cases %>%
          #   filter(Precinct == "UNKNOWN") %>%
          #   select(Dispatch_Blurred_Latitude, Dispatch_Blurred_Longitude) %>%
          #   arrange(Dispatch_Blurred_Latitude)

    # 23 of these cases have invalid lat and long, so they will need to be dropped. 
    # We can assign the other 24
         # focal_cases %>%
         #  filter(Precinct != "UNKNOWN",
         #         Dispatch_Blurred_Latitude == -1) %>%
         #  select(Precinct, Dispatch_Blurred_Latitude, Dispatch_Blurred_Longitude)
    # 5,402 cases with a precinct DO NOT have a valid lat/lng. 

## CREATE SPATIAL OBJECT OF ONLY CASES WITH VALID LAT/LNGS (FOR POINT MAPS)
focal_cases_pts_sf <- focal_cases %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)
    # 5,425 dropped b/c lack valid lat and long
  

## LOAD PRECINCTS & GEOPROCESS
precincts_sf <- st_read(paste0(wd,
                               shp_path, 
                               precs_path, 
                          "geo_export_8e9605ae-b15a-49cc-bcbd-73d6fabe122e.shp"),
                        quiet=F
                        )

precincts_sf <- precincts_sf %>%
    st_transform(., crs = st_crs(focal_cases_pts_sf)) %>%
  select(-descriptio) %>%
  mutate(precinct = recode_factor(name,
                         "E" = "EAST",
                         "N" = "NORTH",
                         "S" = "SOUTH",
                         "SW" = "SOUTHWEST",
                         "W" = "WEST"
                         )
         )
 
## CREATE PRECINCT VIABLE DATAFRAME 
focal_cases_add_precinct_sf <- focal_cases %>%
  filter(Precinct == "UNKNOWN" & (
      Dispatch_Blurred_Latitude != -1 | Dispatch_Blurred_Longitude != -1
      )
    ) %>%
    st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)  %>%
  st_join(.,
          precincts_sf,
          join = st_nearest_feature) %>% 
  select(-Precinct, "Precinct" = precinct, -name) %>%
  relocate(Precinct, .before = Sector)

focal_cases_precincts_full <- focal_cases %>%
  filter(Precinct!= "UNKNOWN") %>%
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)  %>% 
  rbind(., focal_cases_add_precinct_sf) %>%
  st_set_geometry(NULL)

```

```{r interactive point map of different cases}
## INTERACTIVE MAP POINTS COLOR LAYERS BY TYPE OF CASE
cases_pal <- colorFactor(c("navy", "red", "orange"),
                         domain = c("Disturbance", "Suspicious Person", "Trespass"))

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(
    data = disturbances_sf,
    radius = 2,
    color = "#FF0000",
    group = "Disturbance",
    stroke = F,
    fillOpacity = 0.5
    ) %>%
  addCircleMarkers(
    data = suspicious_person_sf,
    radius = 2,
    color = "#52E74B",
    group = "Suspicious Person",
    stroke = F,
    fillOpacity = 0.5
    ) %>%
  addCircleMarkers(
    data = trespass_sf,
    radius = 2,
    color = "#6754D8",
    group = "Trespass",
    stroke = F,
    fillOpacity = 0.5
    ) %>% 
  addLayersControl(
    overlayGroups = c("Disturbance", "Suspicious Person", "Trespass"),
    options = layersControlOptions(collapsed = F)
  )
  
  
```


```{r table of cases by precinct results, warning=F, message=F}
## Calls per precinct - All 3 types
calls_per_precinct_3cases <- focal_cases_precincts_full %>%
  group_by(Precinct) %>%
  summarize(Calls = n()) %>%
  arrange(-Calls) %>%
  mutate(percent = round((Calls/sum(Calls)) * 100, digits=2),
         Calls = scales::comma(Calls))

knitr::kable(calls_per_precinct_3cases,
  caption = "Table: Calls By Precinct for all 3 Case Types",
  col.names = c("Precinct", "# Calls", "%"))

```


```{r graph of precinct x type}
## Calls per precinct x Type Graph
calls_per_precinct_by_case <- focal_cases_precincts_full %>%
  group_by(Precinct, case_type) %>%
  summarize(Calls = n()) %>%
  arrange(Precinct, case_type) %>%
  mutate(percent = round((Calls/sum(Calls)) * 100, digits=2))

focal_cases_precinct_stacked <- ggplot(calls_per_precinct_by_case, aes(fill=case_type, y=Calls, x=Precinct)) + 
  geom_bar(position="fill", stat="identity") +
  scale_fill_brewer(palette = "Set1") +
  labs(
    x = "Precinct",
    y = "Proportion of Calls",
    title = "Distribution of Cases within Precincts",
    subtitle = "Seattle, WA",
    fill = "Case Type",
    caption = "Seattle, WA 2019"
  ) +
  coord_flip() + 
  theme_classic() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    axis.text.x = element_text(hjust=1)
    )
  
focal_cases_precinct_stacked %>%
  ggplotly() %>%
  layout(
    xaxis = list(fixedrange = T),
    yaxis = list(fixedrange = T)
  ) %>%
  config(displayModeBar = F)

```


```{r table of precinct x call type}
## Calls per precinct x Type Table
knitr::kable(calls_per_precinct_by_case %>%
               arrange(case_type, -percent) %>%
               relocate(Precinct, .after = "case_type"),
  caption = "Table: Calls By Precinct & Case Type",
  format.args = list(big.mark = ","),
  col.names = c("Case", "Precinct", "# Calls", "% in Precinct")
  )

```

```{r table of precinct-sector x case type graph, message=F, warning=F}
## Precinct-Sector x Cases Graph
calls_per_precinct_sector_by_case <- focal_cases_precincts_full %>%
  filter(!is.na(Sector)) %>%
  group_by(Precinct, Sector, case_type) %>%
  summarize(Calls = n()) %>%
  arrange(Precinct, case_type) %>%
  mutate(percent = round((Calls/sum(Calls)) * 100, digits=1),
         Sector = factor(Sector, levels = c("BOY", 
                                            "LINCOLN",
                                            "UNION",
                                            "JOHN",
                                            "NORA",
                                            "EDWARD",
                                            "GEORGE",
                                            "CHARLIE",
                                            "SAM",
                                            "OCEAN",
                                            "ROBERT",
                                            "FRANK",
                                            "WILLIAM",
                                            "KING",
                                            "DAVID",
                                            "QUEEN",
                                            "MARY")))


focal_cases_precinct_sector_lolliplot <-  ggplot(calls_per_precinct_sector_by_case, aes(y=Sector, x = percent, label = percent)) + 
  geom_segment(aes(yend = Sector), xend = 0, colour = "grey50") +
  geom_point(aes(color = Precinct), size = 3) +  # Use a larger dot
  #geom_text(nudge_x = 3.7, size = 4) +
  scale_color_brewer(palette = "Dark2") +
  labs(
    x = "Calls within Sector",
    y = "",
    title = "Distribution of Cases within Sectors",
    subtitle = "Seattle, WA",
    fill = "Case Type",
    caption = "Seattle, WA 2019"
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "%"),
                     breaks = c(0, 10, 20, 30, 40, 50, 60, 70)) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
    ) + 
    facet_wrap(~ case_type, scales = "free_x")
  
  
focal_cases_precinct_sector_lolliplot %>%
  ggplotly() %>%
  layout(
    xaxis = list(fixedrange = T),
    yaxis = list(fixedrange = T)
  ) %>%
  config(displayModeBar = F)

```


```{r table of precinct-sector x case types table}
## Calls per precinct x Type Table
knitr::kable(calls_per_precinct_sector_by_case %>%
               arrange(case_type, -percent) %>%
               relocate(case_type, .before = Precinct),
  caption = "Table: Calls By Precinct & Case Type",
  format.args = list(big.mark = ","),
  col.names = c("Case", "Precinct", "Sector", "# Calls", "% in Precinct")
  )

```


```{r graph of case frequency by precinct}
## Table of case frequency by precinct ## REVIEW
knitr::kable(focal_cases_precincts_full %>%
  group_by(Precinct, case_type) %>%
  summarize(Calls = n()) %>%
  arrange(Precinct, case_type) %>%
  mutate(percent = round((Calls/sum(Calls)) * 100, digits=2),
         Calls = scales::comma(Calls)) ,
  caption = "Table: Resolution by Precinct",
  format.args = list(big.mark = ","),
  col.names = c("Precinct", "Case Type", "# Calls", "% in Precinct")
  )

```


```{r resolution by type}
## Resolution by Focal Case Type Lolliplot

focal_cases_lolliplot <- focal_cases %>%
  mutate(Clear_By_Desc = plyr::revalue(Clear_By_Desc, c("-"="NOT LISTED"))) %>%
  count(Clear_By_Desc, case_type) %>%
  ggplot(., aes(x = n, y = reorder(Clear_By_Desc, n), label = comma(n, accuracy=1))) +
  geom_segment(aes(yend = Clear_By_Desc), xend = 0, colour = "grey80") +
  geom_point(size = 3, color = "blue", alpha=0.6) + 
#  geom_text(size = 2.2, nudge_y = -0.5) +  
  labs(title = "Resolutions by Case",
       x = "Calls",
       y = "",
       caption = "Seattle, WA 2019") + 
  scale_x_continuous(labels = scales::comma) +
  theme_classic() +
  theme(
  panel.grid.major.y = element_blank(),
  axis.text.x = element_text(angle = 45, hjust=1),
  #panel.grid.major.y = element_line(colour = "grey60", linetype = "dashed")
) + 
  facet_wrap(~ case_type, scales = "free_x")

focal_cases_lolliplot %>%
  ggplotly() %>%
  layout(
    xaxis = list(fixedrange=T),
    yaxis = list(fixedrange = T)
  ) %>%
  config(displayModeBar = F)

```

**Other Descriptive Statistics**

The majority of calls come from 911. However, the distribution of calls looks a little different for suspicious person reports compared to disturbance and trespass reports. The table below shows that over one-quarter of suspicious-person calls come in via another telephone number, whereas 21% of the reports for trespass and disturbance come in via some other telephone number.

```{r focal cases by Call Type}
## Focal Cases X Call Type Graph
focal_cases_call_type_stacked <- focal_cases %>%
  count(case_type, Call_Type_Desc) %>%
  group_by(case_type) %>%
  mutate(percent = round((n/sum(n)) * 100, digits=2)) %>%
ggplot(., aes(fill=Call_Type_Desc, y=n, x=case_type)) + 
  geom_bar(position="fill", stat="identity") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    x = "Type of Case",
    y = "Proportion of Calls",
    title = "Distribution of Call Types by Case",
    subtitle = "Seattle, WA",
    fill = "Call Type",
    caption = "Seattle, WA 2019"
  ) +
  coord_flip() + 
  theme_classic() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    axis.text.x = element_text(hjust=1)
    )
  
focal_cases_call_type_stacked %>%
  ggplotly() %>%
  layout(
    xaxis = list(fixedrange = T),
    yaxis = list(fixedrange = T)
  ) %>%
  config(displayModeBar = F)

```



## Cases where no police action was possible or necessary

```{r reduce to police action not possible}
no_police_action <- cad %>%
  filter(Clear_By_Desc == "NO POLICE ACTION POSSIBLE OR NECESSARY")

```

