---
title: Seattle 911 Calls for Service - Deep Dive on Disturbance, Suspicious Person,
  and Trespass Cases and Cases resolved with No police action possible
author: "Francine Stephens"
date: "Last Updated: `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: united
    highlight: tango
---

```{r setup, include=F, warning=F, message=F}
knitr::opts_chunk$set(echo=F)

## Libraries
options(tidyverse.quiet = T)
packages <- c(
              "tidyverse",
              "scales",
              "naniar",
              "lubridate",
              "googleway",
              "sf",
              "sp",
              "ggplot2",
              "ggmap",
              "ggpubr",
              "maptools",
              "tmap",
              "raster",
              "spatstat",
              "plotly",
              "KernSmooth",
              "spdep",
              "spDataLarge",
              "tigris",
              "leaflet",
              "RColorBrewer", 
              "censusapi", 
              "tidycensus", 
              "openxlsx",
              "units"
              )
lapply(packages, library, character.only = T)
options(dplyr.summarise.inform = F)

## Local Paths 
setwd("~/Projects/seattle911")
wd <- getwd()
shp_path <- "/shp"
precs_path <- "/Spd_Precincts/"

## PARAMS
wgs <- 4326
proj <- 2285  # NAD 83 USft

```




The goal of this set of analyses is to take a deeper dive into the 2019 Seattle calls for service data. To follow up on the [preliminary exploratory analysis](https://francine-stephens.github.io/francinestephens.github.io/cad19_eda.html), we will focus on three types of cases - Disturbance, Suspicious person, and trespass - as well as one type of case resolution - No possible action possible. The questions we want to address here include the following:

1) Where did the three types of cases occur? 
2) How were these three types of cases resolved?
3) Does the type of resolution differ by location? 
4) What types of cases were cleared without police action? 
5) Where are the cases that were resolved without police action located?


## Focal Case Types

**Where are these 3 types of cases occuring?**
```{r data import, warning=F, message=F}
## IMPORT AND REDUCE TO FOCAL CASE TYPES
cad <- readRDS("cad_2019_data.rds")

cad <- cad %>%
  mutate(event_datetime = mdy_hm(Event_First_Dispatch_Time_ATTR),
         event_date = as.Date(event_datetime),
         event_month = month(event_datetime, label=T), 
         Call_Priority_Code = factor(Call_Priority_Code,
                                     levels = c("-1",
                                                "1",
                                                "2",
                                                "3",
                                                "4",
                                                "5",
                                                "6",
                                                "7",
                                                "8",
                                                "9")),
         case_type_final_desc_first = str_trim(str_extract(Case_Type_Final_Desc, "[^-]+"),
                                          side = c("both")), 
         case_type_final_desc_second = str_trim(str_extract(Case_Type_Final_Desc, "[^-]*$"),
                                           side = c("both")),
         response_time_parsed = seconds_to_period(CAD_Event_Response_Time_Seconds_SUM),
         total_service_time_parsed = seconds_to_period(Total_Service_Time_Seconds_SUM)
  )

focal_cases <- cad %>%
  filter(str_detect(case_type_final_desc_first, 'DIST') |
         Case_Type_Final_Desc == "DV - ARGUMENTS, DISTURBANCE (NO ARREST)" |
         Case_Type_Final_Desc == "NOISE - DIST, GENERAL (CONST, RESID, BALL PLAY)" | 
         Case_Type_Final_Desc == "NOISE - DISTURBANCE (PARTY, ETC)" |
         case_type_final_desc_second == "SUSPICIOUS PERSON" |
         str_detect(Case_Type_Final_Desc, "TRESPASS")) %>%
    mutate(case_type = recode_factor(case_type_final_desc_first,
                                     "DIST" = "Disturbance",
                                     "DISTURBANCE, MISCELLANEOUS/OTHER" = "Disturbance",
                                     "DISTURBANCE" = "Disturbance",
                                     "DV" = "Disturbance",
                                     "NOISE" = "Disturbance",
                                     "SUSPICIOUS CIRCUM." = "Suspicious Person",
                                     "TRESPASS" = "Trespass",
                                     "PROWLER" = "Trespass")
           )


## SUBSET INTO DATAFRAMES OF INTEREST
disturbances_sf <- cad %>% 
  filter(str_detect(case_type_final_desc_first, 'DIST')) %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=wgs)

suspicious_person_sf <- cad %>%
  filter(case_type_final_desc_second == "SUSPICIOUS PERSON") %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=wgs)
  

trespass_sf <- cad %>%
  filter(str_detect(Case_Type_Final_Desc, "TRESPASS")) %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=wgs)


## CASE TYPES TABLE
knitr::kable(focal_cases %>% 
             count(case_type), 
             caption = "Table 1: Frequency of Focal Case Types",
  col.names = c("Case Type", "# of Calls"), 
  format.args = list(big.mark = ",")
)

```


```{r assign locations, include=F, warning=F, message=F}
#summary(focal_cases)
  # 47 cases don't have a precinct/sector
          # focal_cases %>%
          #   filter(Precinct == "UNKNOWN") %>%
          #   select(Dispatch_Blurred_Latitude, Dispatch_Blurred_Longitude) %>%
          #   arrange(Dispatch_Blurred_Latitude)

    # 23 of these cases have invalid lat and long, so they will need to be dropped. 
    # We can assign the other 24
         # focal_cases %>%
         #  filter(Precinct != "UNKNOWN",
         #         Dispatch_Blurred_Latitude == -1) %>%
         #  select(Precinct, Dispatch_Blurred_Latitude, Dispatch_Blurred_Longitude)
    # 5,780 cases with a precinct DO NOT have a valid lat/lng. 

## CREATE SPATIAL OBJECT OF ONLY CASES WITH VALID LAT/LNGS (FOR POINT MAPS)
focal_cases_pts_sf <- focal_cases %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=wgs)
    # 5,780 dropped b/c lack valid lat and long
  

## LOAD PRECINCTS & GEOPROCESS
precincts_sf <- st_read(paste0(wd,
                               shp_path, 
                               precs_path, 
                          "geo_export_8e9605ae-b15a-49cc-bcbd-73d6fabe122e.shp"),
                        quiet=F
                        )

precincts_sf <- precincts_sf %>%
    st_transform(., crs = st_crs(focal_cases_pts_sf)) %>%
  select(-descriptio) %>%
  mutate(precinct = recode_factor(name,
                         "E" = "EAST",
                         "N" = "NORTH",
                         "S" = "SOUTH",
                         "SW" = "SOUTHWEST",
                         "W" = "WEST"
                         )
         )
 
## CREATE PRECINCT VIABLE DATAFRAME 
focal_cases_add_precinct_sf <- focal_cases %>%
  filter(Precinct == "UNKNOWN" & (
      Dispatch_Blurred_Latitude != -1 | Dispatch_Blurred_Longitude != -1
      )
    ) %>%
    st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=wgs)  %>%
  st_join(.,
          precincts_sf,
          join = st_nearest_feature) %>% 
  select(-Precinct, "Precinct" = precinct, -name) %>%
  relocate(Precinct, .before = Sector)

focal_cases_precincts_full <- focal_cases %>%
  filter(Precinct!= "UNKNOWN") %>%
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=wgs)  %>% 
  rbind(., focal_cases_add_precinct_sf) %>%
  st_set_geometry(NULL)

```

```{r interactive point map of different cases}
## INTERACTIVE MAP POINTS COLOR LAYERS BY TYPE OF CASE
cases_pal <- colorFactor(c("red", "blue", "green"),
                         domain = c("Disturbance", "Suspicious Person", "Trespass"))

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(
    data = disturbances_sf,
    radius = 2,
    color = "#FF0000",
    group = "Disturbance",
    stroke = F,
    fillOpacity = 0.5
    ) %>%
  addCircleMarkers(
    data = suspicious_person_sf,
    radius = 2,
    color = "#52E74B",
    group = "Suspicious Person",
    stroke = F,
    fillOpacity = 0.5
    ) %>%
  addCircleMarkers(
    data = trespass_sf,
    radius = 2,
    color = "#6754D8",
    group = "Trespass",
    stroke = F,
    fillOpacity = 0.5
    ) %>% 
  addLayersControl(
    overlayGroups = c("Disturbance", "Suspicious Person", "Trespass"),
    options = layersControlOptions(collapsed = F)
  )
  
```

```{r density of case types}
nhoods_sod_sf <- 
  st_read(
    "https://opendata.arcgis.com/datasets/b76cdd45f7b54f2a96c5e97f2dda3408_2.geojson"
    )

seattle <- nhoods_sod_sf %>%
  mutate(city = "Seattle") %>%
  group_by(city) %>%
  summarize(n_nhoods = n())

## Seattle density
seattle <- precincts_sf %>%
  mutate(city = "Seattle") %>%
  group_by(city) %>%
  summarize(n_precincts = n())

seattle_sqmi <- seattle %>% 
  st_transform(., crs = proj) %>%
  st_area(.) %>%
  set_units(., mi^2) %>%
  as.numeric()

seattle_all_cases_dens <- focal_cases %>%
  mutate(Calls = 1) %>%
  group_by(Calls) %>%
  summarize(Calls = n()) %>%
  mutate(calls_per_sqmi = round(Calls/seattle_sqmi, digits = 2), 
         case_type = "All 3 Focal Cases") %>%
  relocate(case_type, .before = "Calls")
  

knitr::kable(focal_cases %>%
  group_by(case_type) %>%
  summarize(Calls = n()) %>%
  mutate(calls_per_sqmi = round(Calls/seattle_sqmi, digits = 2)) %>%
    rbind(., seattle_all_cases_dens),
  caption = "Table 1: Frequency of Focal Case Types",
  col.names = c("Case Type", "# of Calls", "Calls per Sq. Mile"), 
  format.args = list(big.mark = ",")
)
  
```


Even when we limit our focus to disturbance, trespass, and suspicious person cases, the north and west precincts lead in the number calls. Table 2 indicates that the north and west precincts together had just under 60% of all calls for the three types of cases. Further, the north had just about double the number of calls for these types of cases than the south precinct. 


```{r table of cases by precinct results, warning=F, message=F}
## Calls per precinct - All 3 types
calls_per_precinct_3cases <- focal_cases_precincts_full %>%
  group_by(Precinct) %>%
  summarize(Calls = n()) %>%
  arrange(-Calls) %>%
  mutate(percent = round((Calls/sum(Calls)) * 100, digits=2),
         Calls = scales::comma(Calls))

# Table of all 3 cases by precinct
knitr::kable(calls_per_precinct_3cases,
  caption = "Table 2: Calls By Precinct for all 3 Case Types",
  col.names = c("Precinct", "# Calls", "%"))

```


The bar graph below (Figure 1) breaks down the types of cases within each precinct. Below figure 1, Table 3 presents the frequencies for each case type and precinct. 

*Disturbances are the majority of cases in all precincts.* Although over 50% of the focal cases are disturbance in all five precincts, the northern precinct had about 4 to 5 percentage point fewer disturbance cases than the other four precincts. This seems to be driven by the fact that the northern precinct had a sizable amount of suspicious person cases - 35.5%. 

*The north and southwest precincts lead in the share of suspicious persons.* Just over one-third of the calls in these two precincts are about suspicious persons. In fact, in the southwest precinct, there were only 4,000 fewer calls about suspicious persons than disturbances. 

*The western precinct has the highest number and share of trespass calls.* 22% of all calls in the western precinct were reports of trespassing. Notice that in the western precinct the trespass and suspicious person calls have very similar percentages. No other precincts had two case types that were equally distributed. Lastly, the number of calls about trespassing in the western precinct - 10,216 - doubled the number of calls in each of the other precincts.


```{r graph of precinct x type}
## Calls per precinct x Type Graph
calls_per_precinct_by_case <- focal_cases_precincts_full %>%
  group_by(Precinct, case_type) %>%
  summarize(Calls = n()) %>%
  arrange(Precinct, case_type) %>%
  mutate(percent = round((Calls/sum(Calls)) * 100, digits=2))

focal_cases_precinct_stacked <- ggplot(calls_per_precinct_by_case, aes(fill=case_type, y=Calls, x=Precinct)) + 
  geom_bar(position="fill", stat="identity") +
  scale_fill_brewer(palette = "Set1") +
  labs(
    x = "Precinct",
    y = "Proportion of Calls",
    title = "Fig. 1: Distribution of Cases within Precincts",
    subtitle = "Seattle, WA",
    fill = "Case Type",
    caption = "Seattle, WA 2019"
  ) +
  coord_flip() + 
  theme_classic() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical",
    axis.text.x = element_text(hjust=1)
    )
  
focal_cases_precinct_stacked %>%
  ggplotly() %>%
  layout(
    xaxis = list(fixedrange = T),
    yaxis = list(fixedrange = T)
  ) %>%
  config(displayModeBar = F)

```

```{r table of precinct x call type}
## Calls per precinct x Type Table
knitr::kable(calls_per_precinct_by_case %>%
               arrange(case_type, -percent) %>%
               relocate(Precinct, .after = "case_type"),
  caption = "Table 3: Calls By Precinct & Case Type",
  format.args = list(big.mark = ","),
  col.names = c("Case", "Precinct", "# Calls", "% in Precinct")
  )

```



**Precinct-Sector Level Case Distribution**
```{r table of precinct-sector x case type graph, message=F, warning=F}
## Precinct-Sector x Cases Graph
calls_per_precinct_sector_by_case <- focal_cases_precincts_full %>%
  filter(!is.na(Sector)) %>%
  group_by(Precinct, Sector, case_type) %>%
  summarize(Calls = n()) %>%
  arrange(Precinct, case_type) %>%
  mutate(percent = round((Calls/sum(Calls)) * 100, digits=1),
         Sector = factor(Sector, levels = c("BOY", 
                                            "LINCOLN",
                                            "UNION",
                                            "JOHN",
                                            "NORA",
                                            "EDWARD",
                                            "GEORGE",
                                            "CHARLIE",
                                            "SAM",
                                            "OCEAN",
                                            "ROBERT",
                                            "FRANK",
                                            "WILLIAM",
                                            "KING",
                                            "DAVID",
                                            "QUEEN",
                                            "MARY")))

focal_cases_precinct_sector_lolliplot <- ggplot(
  calls_per_precinct_sector_by_case, aes(y=Sector, x = percent, label = percent)
  ) + 
  geom_segment(aes(yend = Sector), xend = 0, colour = "grey50") +
  geom_point(aes(color = Precinct), size = 3) +  # Use a larger dot
  #geom_text(nudge_x = 3.7, size = 4) +
  scale_color_brewer(palette = "Dark2") +
  labs(
    x = "Calls within Sector",
    y = "",
    title = "Fig. 2: Distribution of Cases within Sectors",
    subtitle = "Seattle, WA",
    fill = "Case Type",
    caption = "Seattle, WA 2019"
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "%"),
                     breaks = c(0, 10, 20, 30, 40, 50, 60, 70)) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
    ) + 
    facet_wrap(~ case_type, scales = "free_x")
  
  
focal_cases_precinct_sector_lolliplot %>%
  ggplotly() %>%
  layout(
    xaxis = list(fixedrange = T),
    yaxis = list(fixedrange = T)
  ) %>%
  config(displayModeBar = F)

```


```{r table of precinct-sector x case types table}
## Calls per precinct x Type Table
knitr::kable(calls_per_precinct_sector_by_case %>%
               arrange(case_type, -percent) %>%
               relocate(case_type, .before = Precinct),
  caption = "Table: Calls By Precinct & Case Type",
  format.args = list(big.mark = ","),
  col.names = c("Case", "Precinct", "Sector", "# Calls", "% in Precinct")
  )

```


```{r graph of case frequency by precinct}
## Table of case frequency by precinct ## REVIEW
knitr::kable(focal_cases_precincts_full %>%
  group_by(Precinct, case_type) %>%
  summarize(Calls = n()) %>%
  arrange(Precinct, case_type) %>%
  mutate(percent = round((Calls/sum(Calls)) * 100, digits=2),
         Calls = scales::comma(Calls)) ,
  caption = "Table: Resolution by Precinct",
  format.args = list(big.mark = ","),
  col.names = c("Precinct", "Case Type", "# Calls", "% in Precinct")
  )

```

**Resolutions by Case Type**

Assistance rendered is the most common type of resolution for each of the three case types. Report written with no arrest is the next most common resolution for disturbance and trespass cases, and the third for suspicious person. Another common resolution was not being able to locate the incident/complainant, ranking third most common for disturbances, second in suspicious person cases, and fifth in trespass cases. 

*No police action deemed possible or necessary was fourth most common resolution for disturbance and suspicious persons cases.* For trespass cases, no police action deemed possible or necessary was the sixth most common resolution with fewer than 1,000 cases.

There were some top-five resolutions that were unique to certain case types. For *disturbances, responding units being canceled by the radio rounded out the top five types of resolutions.*  The ranking of resolutions for suspicious persons cases looked similar to disturbances. However, the *suspicious persons top five was rounded out here with a written street check,* though the total calls is noticeably lower than the no-police action necessary or possible resolution. *The rankings for trespass cases differed from the other two types.* *For trespass cases, physical arrests  and oral warnings were the third and fourth most common resolutions.* Still, the number of trespass cases resolved with arrests and oral warnings are about one-quarter and one-tenth the number resolved by police rendering assistance. 


```{r resolution by type}
## Resolution for Disturbance cases Lolliplot
focal_cases %>%
  filter(case_type == "Disturbance") %>%
  mutate(Clear_By_Desc = plyr::revalue(Clear_By_Desc, c("-"="NOT LISTED"))) %>%
  count(Clear_By_Desc) %>%
  ggplot(., aes(x = n, y = reorder(Clear_By_Desc, n), label = comma(n, accuracy=1))) +
  geom_segment(aes(yend = Clear_By_Desc), xend = 0, colour = "grey80") +
  geom_point(size = 4, color = "red", alpha=0.6) + 
  geom_text(size = 2.5, vjust= -0.9, fontface = "bold") +  
  labs(title = "Resolutions for Disturbance Cases",
       x = "Calls",
       y = "",
       caption = "Seattle, WA 2019") + 
  scale_x_continuous(labels = scales::comma, breaks=pretty_breaks(n=10)) +
  theme_bw() +
  theme(
  panel.grid.major.y = element_blank(),
  axis.text.x = element_text(angle = 45, hjust=1),
  #panel.grid.major.y = element_line(colour = "grey60", linetype = "dashed")
) 

```

```{r suspicious resolutions lplot}
##suspicious_resolutions_lplot
focal_cases %>%
  filter(case_type == "Suspicious Person") %>%
  mutate(Clear_By_Desc = plyr::revalue(Clear_By_Desc, c("-"="NOT LISTED"))) %>%
  count(Clear_By_Desc) %>%
  ggplot(., aes(x = n, y = reorder(Clear_By_Desc, n), label = comma(n, accuracy=1))) +
  geom_segment(aes(yend = Clear_By_Desc), xend = 0, colour = "grey80") +
  geom_point(size = 4, color = "blue", alpha=0.6) + 
  geom_text(size = 2.5, vjust= -0.9, fontface = "bold") +  
  labs(title = "Resolutions for Suspicious Person Cases",
       x = "Calls",
       y = "",
       caption = "Seattle, WA 2019") + 
  scale_x_continuous(labels = scales::comma, breaks=pretty_breaks(n=10)) +
  theme_bw() +
  theme(
  panel.grid.major.y = element_blank(),
  axis.text.x = element_text(angle = 45, hjust=1),
) 

```

```{r trespass resolutions lolliplot}
## Trespass resolutions lolliplot
focal_cases %>%
  filter(case_type == "Trespass") %>%
  mutate(Clear_By_Desc = plyr::revalue(Clear_By_Desc, c("-"="NOT LISTED"))) %>%
  count(Clear_By_Desc) %>%
  ggplot(., aes(x = n, y = reorder(Clear_By_Desc, n), label = comma(n, accuracy=1))) +
  geom_segment(aes(yend = Clear_By_Desc), xend = 0, colour = "grey80") +
  geom_point(size = 4, color = "green", alpha=0.6) + 
  geom_text(size = 2.5, vjust= -0.9, fontface = "bold") +  
  labs(title = "Resolutions for Trespass Cases",
       x = "Calls",
       y = "",
       caption = "Seattle, WA 2019") + 
  scale_x_continuous(labels = scales::comma, breaks=pretty_breaks(n=10)) +
  theme_bw() +
  theme(
  panel.grid.major.y = element_blank(),
  axis.text.x = element_text(angle = 45, hjust=1),
) 

```

Let's focus on the top-5 resolutions for these cases of interest (as well as the (and no police action deemed necessary or possible for trespass, which falls just outside of the top 5). In the map series below we start to map these out. 

```{r parse out the top 5 resolution types for each case type}
## Pull top 5 resolutions for different case types
resol_dist_top5 <- focal_cases %>%
  filter(case_type == "Disturbance") %>%
  mutate(Clear_By_Desc = plyr::revalue(Clear_By_Desc, c("-"="NOT LISTED"))) %>%
  count(Clear_By_Desc) %>% 
  arrange(-n) %>%
  slice(1:5)

resol_suspicious_top5 <- focal_cases %>%
  filter(case_type == "Suspicious Person") %>%
  mutate(Clear_By_Desc = plyr::revalue(Clear_By_Desc, c("-"="NOT LISTED"))) %>%
  count(Clear_By_Desc) %>% 
  arrange(-n) %>%
  slice(1:5)

resol_trespass_top6 <- focal_cases %>%
  filter(case_type == "Trespass") %>%
  mutate(Clear_By_Desc = plyr::revalue(Clear_By_Desc, c("-"="NOT LISTED"))) %>%
  count(Clear_By_Desc) %>% 
  arrange(-n) %>%
  slice(1:6)
  
## DFs for case-resol top 5
dist_resol_filter_sf <- disturbances_sf %>%
  filter(Clear_By_Desc %in% resol_dist_top5$Clear_By_Desc) %>%
  mutate(
    Clear_By_Desc = plyr::revalue(Clear_By_Desc, 
                                  c("NO POLICE ACTION POSSIBLE OR NECESSARY" = "NO POLICE ACTION",
                                  "UNABLE TO LOCATE INCIDENT OR COMPLAINANT" = "UNABLE TO LOCATE",
                                  "RESPONDING UNIT(S) CANCELLED BY RADIO" = "CANCELLED BY RADIO"))
  )

sus_resol_filter_sf <- suspicious_person_sf %>%
    filter(Clear_By_Desc %in% resol_suspicious_top5$Clear_By_Desc) %>%
      mutate(
        Clear_By_Desc = plyr::revalue(Clear_By_Desc, 
                                  c("NO POLICE ACTION POSSIBLE OR NECESSARY" = "NO POLICE ACTION",
                                  "UNABLE TO LOCATE INCIDENT OR COMPLAINANT" = "UNABLE TO LOCATE"
                                  ))
      )

tres_resol_filter_sf <- trespass_sf %>%
    filter(Clear_By_Desc %in% resol_trespass_top6$Clear_By_Desc)  %>%
      mutate(
        Clear_By_Desc = plyr::revalue(Clear_By_Desc, 
                                  c("NO POLICE ACTION POSSIBLE OR NECESSARY" = "NO POLICE ACTION",
                                  "UNABLE TO LOCATE INCIDENT OR COMPLAINANT" = "UNABLE TO LOCATE"
                                  ))
      )

```


```{r map the locations of disturbance by respl}
## MAP DISTURBANCE CASES BY RESOLUTION
tm_shape(dist_resol_filter_sf) +
    tm_dots(col = "red", legend.show = F) +
    tm_facets(by = "Clear_By_Desc") +
    tm_shape(seattle) +
    tm_borders(col = "black")

```

```{r map the locations sus person by resol}
## MAP SUSPICIOUS PERSONS CASES BY RESOLUTION
tm_shape(sus_resol_filter_sf) +
    tm_dots(col = "blue", legend.show = F) +
    tm_facets(by = "Clear_By_Desc", nrow = 2) +
    tm_shape(seattle) +
    tm_borders(col = "black")

```

```{r map the locations trespass person by resol}
## MAP SUSPICIOUS PERSONS CASES BY RESOLUTION
tm_shape(tres_resol_filter_sf ) +
    tm_dots(col = "green", legend.show = F) +
    tm_facets(by = "Clear_By_Desc", nrow = 2) +
    tm_shape(seattle) +
    tm_borders(col = "black")

```

## Cases where no police action was possible or necessary

No police action was deemed possible or necessary for 19,290 calls. There are 63 types of cases that had been deemed impossible or unnecessary for police action to be taken.  In the graph below, the number of calls for each of the top 20 case types with the no police action resolution are shown. You can see disturbance and suspicious person are the top 2 most common. Disturbance calls make up about 27% of these cases and suspicious person cases are 15%. Trespass cases are in the top 20, but rank lower than our other two focal cases at 9th most frequent. 

*Other Thoughts:*

* Suspicious circumstances - The frequencies seem to closely track with suspicious person cases. Perhaps run comparisons between suspicious persons and circumstances spatially. 
* Prowler - Trespass and prowler also tend to mirror each other in tabulations. Tracking these two spatially may be useful too.

```{r reduce to police action not possible}
## Reduce to no police action resolutions
no_police_action <- cad %>%
  filter(Clear_By_Desc == "NO POLICE ACTION POSSIBLE OR NECESSARY")

```

```{r case type counts for no police action}
## EXPORT no police action case types
no_police_action_case_types <- no_police_action %>% 
  group_by(Case_Type_Final_Desc) %>%
  summarize(freq = n()
            ) %>%
  mutate(percent = round((freq/sum(freq)) * 100, digits=2)) %>%
  arrange(-freq)

# write_csv(no_police_action_case_types,
#           "no_police_action_case_types.csv",
#           na = "")

rm(no_police_action_case_types)

```

```{r case type counts for no police action agg case type}
## AGGREGATE case types for graphing
no_police_action_case_freq <- no_police_action %>% 
  mutate(
         Case_Type_Final_Desc = str_replace(
           Case_Type_Final_Desc, c("PROWLER - TRESPASS", 
                                   "PROWLER - TRESPASS, PARKS EXCLUSION"), "TRESPASS"),
         Case_Type_Final_Desc = str_replace(
           Case_Type_Final_Desc, "DV - ARGUMENTS, DISTURBANCE (NO ARREST)", 
           "DISTURBANCE - DV"),
         Case_Type_Final_Desc = str_replace(Case_Type_Final_Desc, 
                                            "NOISE - DIST, GENERAL (CONST, RESID, BALL PLAY)",
                                            "DISTURBANCE - NOISE, GENERAL"),
         Case_Type_Final_Desc = str_replace(Case_Type_Final_Desc, 
                                            "NOISE - DISTURBANCE (PARTY, ETC)", 
                                            "DISTURBANCE - NOISE, GENERAL"),
         Case_Type_Final_Desc = str_replace(Case_Type_Final_Desc, 
                                            "SUSPICIOUS CIRCUM. - SUSPICIOUS PERSON",
                                            "SUSPICIOUS PERSON"),
         Case_Type_Final_Desc = str_replace(Case_Type_Final_Desc, 
                                            "ASSAULTS, OTHER",
                                            "ASSAULTS"),
         Case_Type_Final_Desc = str_replace(Case_Type_Final_Desc, 
                                            "PERSON - RUNAWAY",
                                            "RUNAWAY PERSON"),
         case_type_final_desc_first = str_trim(str_extract(Case_Type_Final_Desc, "[^-]+")), 
         case_type_final_desc_first = recode_factor(case_type_final_desc_first,
                                     "TRESPASS, PARKS EXCLUSION" = "TRESPASS",
                                     "CASUALTY,NON" = "CASUALTY NON CRIMINAL",
                                     "#NAME?" = "UNKNOWN",
                                     "UNKNOWN?" = "UNKNOWN",
                                     "HAZ" = "HAZARDS",
                                     "SEX OFFENSES (NON" = "SEX OFFENSES (NON RAPE)",
                                     "MISSING" = "MISSING PERSON",
                                     "PERSON" = "MISSING PERSON",
                                     "HARAS" = "HARASSMENT",
                                     "DOWN" = "DOWN PERSON",
                                     "BURN" = "RECKLESS BURNING",
                                     "SERVICE" = "WELFARE CHECK",
                                     "WEAPN" = "WEAPON",
                                     "WEAPON,PERSON WITH" = "WEAPON",
                                     "WEAPON, PERSON WITH" = "WEAPON",
                                     "CASUALTY NON" = "CASUALTY DRUG RELATED",
                                     "DISTURBANCE, MISCELLANEOUS/OTHER" = "DISTURBANCE",
                                     "NUISANCE" = "NUISANCE OR MISCHIEF",
                                     "CHILD" = "ABANDONED, ABUSED AND NEGLECTED CHILD"
                                     )) %>%
  group_by(case_type_final_desc_first) %>%
  summarize(n = n()
            ) %>%
  mutate(percent = round((n/sum(n)) * 100, digits=2)) %>%
  arrange(-n) 

## Graph of top 20
no_police_action_case_freq %>%
  slice(1:20) %>%
 ggplot(., aes(x = n, y = reorder(case_type_final_desc_first, n), label = comma(n, accuracy=1))) +
  geom_segment(aes(yend = case_type_final_desc_first), xend = 0, colour = "grey80") +
  geom_point(size = 7.5, color = "blue", alpha=0.6) + 
  geom_text(size = 2, color = "white", fontface = "bold") +  
  labs(title = "Top 20 cases where police action was not possible or necessary",
       x = "# of Calls",
       y = "",
       caption = "Seattle, WA 2019") + 
  scale_x_continuous(labels = scales::comma, breaks=pretty_breaks(n=10)) +
  theme_bw() +
  theme(
  panel.grid.major.y = element_blank(),
  axis.text.x = element_text(angle = 45, hjust=1),
  #panel.grid.major.y = element_line(colour = "grey60", linetype = "dashed")
)

```


```{r Create & Map points for cases where no police action is possible, warning=F, message=F}
## CREATE SPATIAL OBJECT OF ONLY CASES WITH VALID LAT/LNGS (FOR POINT MAP)
no_police_action_pts_sf <- no_police_action %>%
  filter(Dispatch_Blurred_Longitude != -1 | Dispatch_Blurred_Latitude != -1) %>% 
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)

no_police_action_pal <- colorFactor(
  palette = "Spectral",
  domain = no_police_action_pts_sf$Clear_By_Desc)


leaflet(no_police_action_pts_sf) %>% 
  addTiles() %>% 
  addCircleMarkers(
    radius = 1.25,
    fillColor = ~no_police_action_pal(Clear_By_Desc),
    color = "black",
    opacity = 0.5,
    fillOpacity = 1,
    weight = 1
) %>%
  addLegend(
    data = no_police_action_pts_sf,
    pal = no_police_action_pal,
    values = ~Clear_By_Desc,
    title = "2019 Service Callsresolved<br>without police action"
  )

```

The precinct-level map shows that the cases resolved without police action are largely in the north and west precincts. 

```{r precinct map of no police action, warning=F, message=F}
## CREATE PRECINCT VIABLE DATAFRAME FOR NO POLICE ACTION
no_police_action_add_precinct_sf <- no_police_action %>%
  filter(Precinct == "UNKNOWN" & (
      Dispatch_Blurred_Latitude != -1 | Dispatch_Blurred_Longitude != -1
      )
    ) %>%
    st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)  %>%
  st_join(.,
          precincts_sf,
          join = st_nearest_feature) %>% 
  select(-Precinct, "Precinct" = precinct, -name) %>%
  relocate(Precinct, .before = Sector)

no_police_action_precincts_full <- no_police_action %>%
  filter(Precinct!= "UNKNOWN") %>%
  st_as_sf(coords=c("Dispatch_Blurred_Longitude", "Dispatch_Blurred_Latitude"),
           crs=4326)  %>% 
  rbind(., no_police_action_add_precinct_sf) %>%
  st_set_geometry(NULL)
  
## MAP NO POLICE ACTION BY PRECINCTS
no_police_action_precincts_sf <- no_police_action_precincts_full %>%
  group_by(Precinct) %>%
  summarize(Calls = n()) 

no_police_precincts_sf <- precincts_sf %>% 
  left_join(., no_police_action_precincts_sf, by = c("precinct" = "Precinct"))

precinct_pal_no_police_action <- colorNumeric(
  palette = "Purples",
  domain = no_police_precincts_sf$Calls
)

leaflet() %>%
addTiles() %>% 
addPolygons(
    data = no_police_precincts_sf,
    fillColor = ~precinct_pal_no_police_action(Calls),
    color = "Black",
    opacity = 0.5,
    fillOpacity = 0.5,
    weight = 1.5,
    label = ~paste0(precinct, " - Total: ",
      format(Calls, big.mark = ","))
    ) %>% 
addLegend(
  data = no_police_precincts_sf,
  pal = precinct_pal_no_police_action,
  values = ~Calls,
  title = "Service Calls resolved without<br>police action per Precinct"
  )

```


```{r no police action by sector, warning=F, message=F}
## SP OBJECTS
seattle_sp <- seattle %>%
  st_transform(., crs=proj) %>%
  as(., "Spatial")
seattle_Owin <- as.owin(seattle_sp)


no_police_action_pts_sf <- st_transform(no_police_action_pts_sf, crs=proj)
no_police_action_pts_coords <- matrix(unlist(no_police_action_pts_sf$geometry),
                                      ncol = 2,
                                      byrow =T)
no_police_action_pts_ppp <- ppp(x = no_police_action_pts_coords[,1],
                                y = no_police_action_pts_coords[,2], 
                                window = seattle_Owin, check = T)
no_police_action_pts_sp <- no_police_action_pts_sf %>%
  st_transform(., crs = proj) %>%
  as(., "Spatial")


## Density plot 1
#dens_no_police_action <- density(no_police_action_pts_ppp)
no_police_action_pts_ppp_jitter <- rjitter(no_police_action_pts_ppp,
                                        retry=TRUE,
                                        nsim=1,
                                        drop=T)

dens_no_police_action <- density.ppp(no_police_action_pts_ppp,
                                     sigma = bw.diggle(no_police_action_pts_ppp), 
                                     edge=T)

#plot(dens_no_police_action, main='Density of Cases Where No Police Action was Taken')

```

**Kernel Density**
```{r raster no police action, warning=F, message=F}
## Raster Kernel Density
pixelsize = 100
box = round(extent(seattle_sp) / pixelsize) * pixelsize
template = raster(box, crs = proj,
	nrows = (box@ymax - box@ymin) / pixelsize, 
	ncols = (box@xmax - box@xmin) / pixelsize)

no_police_action_pts_sp$PRESENT = 1
raster_no_pol_action = rasterize(no_police_action_pts_sp,
                                 template,
                                 field = 'PRESENT',
                                 fun = sum)
# plot(raster_no_pol_action)
# plot(seattle_sp, border='#00000040', add=T)


kernel = focalWeight(raster_no_pol_action, d = 264, type = 'Gauss')
heat = focal(raster_no_pol_action, kernel, fun = sum, na.rm=T)

plot(heat, main='Kernel Density of Cases Where No Police Action was Taken')
plot(seattle_sp, border="gray", add=T)

```

**Getis- Ord GI static Map**
```{r getis ord gi no police action, warning=F, message=F}

# Create a regular grid of 1/8-mile-square crime areas via a raster
pixelsize = 660
box = round(extent(seattle_sp) / pixelsize) * pixelsize
template = raster(box, crs = proj,
	nrows = (box@ymax - box@ymin) / pixelsize, 
	ncols = (box@xmax - box@xmin) / pixelsize)

no_police_action_pts_sp$PRESENT = 1
getisraster = rasterize(no_police_action_pts_sp, template, field = 'PRESENT', fun = sum)
getisgrid = rasterToPolygons(getisraster)

# Create the list of neighbors
neighbors = poly2nb(getisgrid)
weighted_neighbors = nb2listw(neighbors, zero.policy=T)

# Perform the local G analysis (Getis-Ord GI*)
getisgrid$HOTSPOT = as.vector(localG(getisgrid$layer, weighted_neighbors))

# Color the grid cells based on the z-score
breaks = c(-20, -1.96, -1, 1, 1.96, 20)
palette=c("#0000FF80", "#8080FF80", "#FFFFFF80", "#FF808080", "#FF000080")
col = palette[cut(getisgrid$HOTSPOT, breaks)]

# Plot
plot(getisgrid, col=col, border=NA) 
plot(seattle_sp, border="gray", add=T)

```

**Interactive Map of Getis-Ord GI Hot Spots**
```{r leaflet the grid, warning=F, message=F}
getisgrid <- spTransform(getisgrid, CRS("+init=epsg:4326"))
no_pol_action_getis_pal <- 
  colorBin(palette = c("#0000FF80",
                       "#8080FF80",
                       "#FFFFFF80",
                       "#FF808080", 
                       "#FF000080"),
           bins=breaks,
           na.color = "#808080")

leaflet() %>%
  addTiles() %>%
  addPolygons(data = seattle_sp %>% spTransform(., CRS("+init=epsg:4326")),
              fill = F, 
              color = "black", 
              weight = 1.5
    ) %>%
  addPolygons(data = getisgrid, 
              color = ~no_pol_action_getis_pal(HOTSPOT),
              stroke = F,
              fillOpacity = 0.5,
              smoothFactor = 0.5,
  ) %>%
  addLegend(data = getisgrid,
  colors = c("#0000FF80", "#8080FF80", "#FFFFFF80", "#FF808080", "#FF000080", "#808080"),
  labels = c("Cold Spot >95% Confidence", 
             "Cold Spot 68-95% Confidence", 
             "Not Significant",
             "Hot Spot 68 - 95% Confidence", 
             "Hot Spot >95% Confidence", 
             "NA"),
  title = "Getis-Ord GI Hot-Spots of<br>No Police Action Resolutions") %>%
  setView(lng = -122.3321,lat = 47.6062, zoom = 11)

```

